flowchart TD
    Start([Webhook Request]) --> A[Parse Request JSON]
    A --> B{Extract Data}
    B --> |jobId| C[Job ID]
    B --> |status| D[Status]
    B --> |error| E[Error Message]
    
    C & D & E --> F{Get Job from Repository}
    F -->|Job Not Found| G[Resource Not Found Exception]
    
    F -->|Job Found| H{Check Status}
    
    %% Success Flow
    H -->|status = 200| I[Handle Success Case]
    I --> J{Check Job Type}
    J --> K[Process TPI Data]
    
    %% Common Success Steps
    J --> Q[Update Job Meta]
    Q3 --> R[Reset Fail Count]
    R --> S[Set Alert False]
    S --> T[Update Schedule Time]
    T --> U[Save Job]
    U --> V[Schedule Next Task]
    
    %% Error Flow
    H -->|status != 200| W[Handle Error Case]
    W --> X[Get Job Meta]
    X --> Y[Increment Fail Count]
    
    Y --> Z{Check Fail Count}
    Z -->|< Max Allowed| AA{Check Job Type}
    AA -->|BaseParse:tataFleetMan or nsTracker| AB[Apply Retry Mechanism]
    AA -->|Other| AC[Schedule Next Attempt]
    
    Z -->|Max Limit Reached| AD[Set Need Alert]
    AD --> AE[Update Schedule Time]
    AE --> AF[Set Event Type Update]
    
    AB & AC & AF --> AG[Save Job Meta]
    AG --> AH[Update Last Schedule]
    AH --> AI[Save Job State]
    
    %% Final Steps
    V & AI --> End([Return Response])
    
    %% Subgraph for Position Processing
    subgraph If Not Prehook
        
        K --> L{Check DisableVehicleSync}
        L -->|false| M[Compare & Process Changes]
        L -->|true| N[Skip Vehicle Sync]
        M & N --> O[Process Positions]
        O --> O1[Clean IMEI]
        O1 --> O2[Produce to Kafka]
    end
        O2 --> Q
        Q --> Q1[Update Last Schedule]
        Q1 --> Q2[Update Next Schedule]
        Q2 --> Q3[Update Fail Count]
    
    %% Styling
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    
    class A,K,M,N,O,P,Q,R,S,T,U,V process
    class H,J,L,Z,AA decision
    class G,W,ErrorLog error
    class I,AB,AC success
