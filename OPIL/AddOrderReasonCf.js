// console.log($event.shipmentNumber)
const sh = {
    "creationTime": 1736416699849,
    "customFields": [
        {
            "indexedValue": [
                "FreightCost_1.0"
            ],
            "fieldKey": "FreightCost",
            "multiple": false,
            "description": null,
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": "string",
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "1.0",
            "isRemark": false
        },
        {
            "indexedValue": [
                "FreightType_perMT"
            ],
            "fieldKey": "FreightType",
            "multiple": false,
            "description": null,
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": "string",
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "perMT",
            "isRemark": false
        },
        {
            "indexedValue": [
                "PONo_cbc904d9-a2a0-49c0-a2e5-2176e7ae478e"
            ],
            "fieldKey": "PONo",
            "multiple": false,
            "description": null,
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": "string",
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "cbc904d9-a2a0-49c0-a2e5-2176e7ae478e",
            "isRemark": false
        },
        {
            "indexedValue": [
                "Gate Entry Number_6000001171"
            ],
            "fieldKey": "Gate Entry Number",
            "multiple": false,
            "description": "",
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "6000001171",
            "isRemark": false
        },
        {
            "indexedValue": [
                "Gate Entry Time_09.01.2025 15:29:41"
            ],
            "fieldKey": "Gate Entry Time",
            "multiple": false,
            "description": "",
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "09.01.2025 15:29:41",
            "isRemark": false
        },
        {
            "indexedValue": [
                "Tare Weight (Gate Entry)_0"
            ],
            "fieldKey": "Tare Weight (Gate Entry)",
            "multiple": false,
            "description": "",
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "0",
            "isRemark": false
        },
        {
            "indexedValue": [
                "Gross Weight (Gate Entry)_0"
            ],
            "fieldKey": "Gross Weight (Gate Entry)",
            "multiple": false,
            "description": "",
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "0",
            "isRemark": false
        },
        {
            "indexedValue": [
                "Gross Vehicle Weight (Gate Entry)_15"
            ],
            "fieldKey": "Gross Vehicle Weight (Gate Entry)",
            "multiple": false,
            "description": "",
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "15",
            "isRemark": false
        },
        {
            "indexedValue": [
                "RTO GVW_15"
            ],
            "fieldKey": "RTO GVW",
            "multiple": false,
            "description": "",
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "15",
            "isRemark": false
        },
        {
            "indexedValue": [
                "4000001491_8100002489_DI_30"
            ],
            "fieldKey": "4000001491_8100002489_DI",
            "multiple": false,
            "description": null,
            "remark": null,
            "uuid": null,
            "required": false,
            "accessType": null,
            "input": null,
            "unit": null,
            "valueType": "string",
            "options": null,
            "fieldType": "text",
            "value": "30",
            "isRemark": false
        }
    ],
    "transportationMode": "ByRoad",
    "freightUnitLineItemId": "8159e249-fe01-49e7-96b6-fd3bb23bc5bd",
    "lastSyncUpTime": 1736416825927,
    "updates": {
        "traceID": "shservicescheduletask_4_11960",
        "resourceId": "a3776e63-b8ff-4f63-afe1-e97fe56d0a45",
        "updatedBy": "SYSTEM",
        "changes": null,
        "sourceOfInformation": null,
        "description": null,
        "forwardReasons": [
            "HEART-BEAT"
        ],
        "userId": null,
        "uuid": "12b94c7d-7381-4881-861a-64d71edf5b56",
        "revision": 100,
        "time": 1736912781152,
        "forwardedFrom": null,
        "resourceType": "ShipmentObject",
        "updateType": null
    },
    "isActive": false,
    "uuid": "a3776e63-b8ff-4f63-afe1-e97fe56d0a45",
    "issues": null,
    "branch": null,
    "orgId": "7d7304f0-5638-470b-be88-6fa6f9be24b4",
    "shipmentType": "DirectLeg",
    "completionTime": null,
    "orderNumbers": [
        "4000001491"
    ],
    "routeId": "Waiting For GateOut",
    "shipmentTrackingStatus": "At Pickup Point",
    "lastForwardTime": 1736912781158,
    "runningStatus": null,
    "delayTrackingStatus": "UP TO DATE",
    "delayReasonLastUpdateTime": null,
    "links": null,
    "shipmentDate": 1736416699763,
    "delayReason": null,
    "shipmentNumber": "FRETSH000000034",
    "originalEdd": null,
    "edd": null,
    "delayReasonUpdateExpiryTime": null,
    "externalShipmentId": "6000001171",
    "fleetInfo": {
        "isTrackingEnable": null,
        "forwardingAgent": null,
        "verificationStatus": null,
        "trackingMode": "MANUAL",
        "broker": {
            "geoFence": null,
            "documents": null,
            "customFields": null,
            "isPortalEnabled": false,
            "type": null,
            "updates": null,
            "uuid": "c3393a3b-9556-4fea-b359-0b201c94b40d",
            "orgId": null,
            "firmType": null,
            "gstn": null,
            "voterId": null,
            "verificationTicketId": null,
            "companyCodes": null,
            "group": null,
            "address": null,
            "verificationStatus": null,
            "externalId": "2000148",
            "panNumber": null,
            "aadharNo": null,
            "parentId": null,
            "places": null,
            "route": null,
            "name": "JOLLY ROAD LINES",
            "location": null,
            "fretronId": null,
            "contacts": [
                {
                    "emails": [
                        "daljit.jolly@rediffmail.com"
                    ],
                    "address": null,
                    "mobileNumbers": [
                        "9827013592",
                        "9425153092"
                    ],
                    "mobileNumber": null,
                    "name": "Satinder Singh",
                    "type": null
                },
                {
                    "emails": [],
                    "address": null,
                    "mobileNumbers": [
                        "9923629038"
                    ],
                    "mobileNumber": null,
                    "name": "Ravendra Tripathi",
                    "type": null
                },
                {
                    "emails": [],
                    "address": null,
                    "mobileNumbers": [
                        "9981693892"
                    ],
                    "mobileNumber": null,
                    "name": "Manveer Singh",
                    "type": null
                }
            ],
            "status": "ACTIVE"
        },
        "uuid": null,
        "orgId": null,
        "vehicle": {
            "vtsDeviceId": null,
            "kmDriven": null,
            "secondaryDriverId": null,
            "attachedDocs": null,
            "customFields": null,
            "floorType": null,
            "description": null,
            "source": "FRETRON",
            "isTrackingEnabled": null,
            "updates": null,
            "uuid": null,
            "branch": null,
            "orgId": null,
            "vehicleLoadType": {
                "bodyType": "OPEN",
                "passingCapacityMT": 30,
                "minLength": 27,
                "updates": {
                    "traceID": null,
                    "resourceId": "ea0bfd2b-83bf-4b44-a2ca-017236cc2659",
                    "updatedBy": "USER",
                    "changes": null,
                    "sourceOfInformation": null,
                    "description": "Created Load Type.",
                    "forwardReasons": [
                        "load.type.created.event"
                    ],
                    "userId": "a0a838f0-2758-4c0c-ae90-6e3338242bae",
                    "uuid": "b79b636f-3c79-4963-adc9-806a56905961",
                    "revision": null,
                    "time": 1726641969916,
                    "forwardedFrom": null,
                    "resourceType": "LoadTypes",
                    "updateType": null
                },
                "vehicleCategories": [],
                "type": "FTL",
                "uuid": "ea0bfd2b-83bf-4b44-a2ca-017236cc2659",
                "orgId": "7d7304f0-5638-470b-be88-6fa6f9be24b4",
                "vehicleCategory": "BIG",
                "includeMaxLength": false,
                "minHeight": 9.6,
                "maxHeight": 9.6,
                "passingCapacityCFT": 2073.6,
                "bodyTypes": [],
                "partnerName": null,
                "includeMinLength": false,
                "partnerExternalId": null,
                "externalId": "12",
                "chassisTypes": [],
                "numberOfWheels": null,
                "chassisType": "TRUCK",
                "includeMinHeight": false,
                "name": "OPEN TRUCK 27 FT 30MT",
                "partnerId": null,
                "includeMaxHeight": false,
                "dimensionString": "27*8*9.6",
                "maxLength": 27
            },
            "associatedWith": null,
            "isDeleted": null,
            "customerId": null,
            "vehicleModel": null,
            "mileageEmpty": null,
            "mileageLoaded": null,
            "vehicleType": "OPEN TRUCK 27 FT 30MT",
            "groups": null,
            "externalId": null,
            "updateTime": null,
            "sharedWith": null,
            "baseLocationId": null,
            "vehicleMake": null,
            "vehicleRegistrationNumber": "HP26B0322",
            "chassisNumber": null,
            "driverId": null,
            "createTime": null,
            "loadCapacity": 30,
            "truckLength": null,
            "category": null,
            "groupsExtended": null
        },
        "driver": {
            "pincode": null,
            "dlExpiryTime": null,
            "attachedDocs": null,
            "isEmployee": false,
            "pfNumber": null,
            "address": null,
            "mobileNumbers": null,
            "dlNumber": null,
            "mobileNumber": "7018510181",
            "customFields": null,
            "externalId": null,
            "updates": null,
            "aadharNo": null,
            "type": null,
            "uuid": null,
            "branch": null,
            "orgId": null,
            "vehicleRegistrationNumber": null,
            "dob": 910117800000,
            "name": "Shivam",
            "vehicleId": null,
            "associatedUserId": null,
            "status": null
        },
        "fleetType": "Market",
        "fleetOwner": {
            "geoFence": null,
            "documents": null,
            "customFields": null,
            "isPortalEnabled": false,
            "type": null,
            "updates": null,
            "uuid": "c3393a3b-9556-4fea-b359-0b201c94b40d",
            "orgId": null,
            "firmType": null,
            "gstn": null,
            "voterId": null,
            "verificationTicketId": null,
            "companyCodes": null,
            "group": null,
            "address": null,
            "verificationStatus": null,
            "externalId": "2000148",
            "panNumber": null,
            "aadharNo": null,
            "parentId": null,
            "places": null,
            "route": null,
            "name": "JOLLY ROAD LINES",
            "location": null,
            "fretronId": null,
            "contacts": [
                {
                    "emails": [
                        "daljit.jolly@rediffmail.com"
                    ],
                    "address": null,
                    "mobileNumbers": [
                        "9827013592",
                        "9425153092"
                    ],
                    "mobileNumber": null,
                    "name": "Satinder Singh",
                    "type": null
                },
                {
                    "emails": [],
                    "address": null,
                    "mobileNumbers": [
                        "9923629038"
                    ],
                    "mobileNumber": null,
                    "name": "Ravendra Tripathi",
                    "type": null
                },
                {
                    "emails": [],
                    "address": null,
                    "mobileNumbers": [
                        "9981693892"
                    ],
                    "mobileNumber": null,
                    "name": "Manveer Singh",
                    "type": null
                }
            ],
            "status": "ACTIVE"
        },
        "trainInfo": null,
        "lbsNumber": null,
        "secondaryDriver": {
            "pincode": null,
            "dlExpiryTime": null,
            "attachedDocs": null,
            "isEmployee": false,
            "pfNumber": null,
            "address": null,
            "mobileNumbers": null,
            "dlNumber": null,
            "mobileNumber": null,
            "customFields": null,
            "externalId": null,
            "updates": null,
            "aadharNo": null,
            "type": null,
            "uuid": null,
            "branch": null,
            "orgId": null,
            "vehicleRegistrationNumber": null,
            "dob": null,
            "name": null,
            "vehicleId": null,
            "associatedUserId": null,
            "status": null
        },
        "device": null,
        "status": null
    },
    "syncUpDueTime": 1831024825933,
    "billingStatus": null,
    "currentLocation": null,
    "alerts": [],
    "equipments": null,
    "tripType": "Shipment",
    "lastDelayCalculationTime": null,
    "delayReasonUpdateDueTime": null,
    "locationTrackingStatus": "UP TO DATE",
    "poLineItemId": "dc395abc-b5bc-4f7f-b7b5-2cd0152fc0a1",
    "consignments": [],
    "customContacts": null,
    "shipmentStages": [
        {
            "departureTime": null,
            "gateInTime": null,
            "actualActivityStartTime": null,
            "actualActivityEndTime": null,
            "preActWtTime": null,
            "uuid": "9322ef95-7e2c-44cf-8f64-1dd8c6e78952",
            "consignmentDelivered": null,
            "resourceDropOff": null,
            "resourcePickup": null,
            "eta": null,
            "stageName": "ORIENT PAPER MILLS - Amlai, Orient Paper,P.O. Amlai Paper Mills, Madhya Pradesh 484117",
            "hub": {
                "hubId": null,
                "boundary": null,
                "address": null,
                "accessibility": null,
                "addedBy": null,
                "center": {
                    "latitude": 23.197871636791923,
                    "longitude": 81.58799238066777
                },
                "suggestedRadius": 0,
                "isOwned": null,
                "centerCoordinates": [
                    81.58799238066777,
                    23.197871636791923
                ],
                "placeId": "ee5a623b-c714-4848-8589-229b35989d43",
                "geoJsonBoundry": null,
                "externalId": null,
                "source": "GOOGLE",
                "places": null,
                "viewport": null,
                "district": null,
                "name": "Orient Paper,P.O. Amlai Paper Mills, Madhya Pradesh 484117",
                "state": null,
                "category": "Hub",
                "subDistrict": null,
                "controllingBranchId": null
            },
            "arrivalTime": 1736416781000,
            "expectedActivityStartTime": null,
            "secondaryStatus": "WaitingForGateIn",
            "consignmentPickUps": null,
            "postActWtTime": null,
            "tripPoint": {
                "outOfTrackSince": null,
                "creationTime": null,
                "purpose": "Pickup",
                "plannedArrival": null,
                "currentGpsState": null,
                "updates": null,
                "uuid": "9322ef95-7e2c-44cf-8f64-1dd8c6e78952",
                "sequenceId": null,
                "isDisconnected": false,
                "isOutOfTrack": false,
                "routeDeviationMinimumDistanceConstraint": null,
                "eta": null,
                "routeId": null,
                "expectedActivityStartTime": null,
                "actualDeparture": null,
                "vehicleId": null,
                "place": null,
                "isOverSpeed": false,
                "remainingDistance": null,
                "actualActivityStartTime": null,
                "forShipmentStages": [
                    "9322ef95-7e2c-44cf-8f64-1dd8c6e78952"
                ],
                "actualActivityEndTime": null,
                "actualArrival": null,
                "purposedDistance": null,
                "plannedDeparture": null,
                "currentLocation": null,
                "isAutoCompleted": false,
                "coveredDistance": null,
                "hub": {
                    "hubId": null,
                    "boundary": null,
                    "address": null,
                    "accessibility": null,
                    "addedBy": null,
                    "center": {
                        "latitude": 23.197871636791923,
                        "longitude": 81.58799238066777
                    },
                    "suggestedRadius": 0,
                    "isOwned": null,
                    "centerCoordinates": [
                        81.58799238066777,
                        23.197871636791923
                    ],
                    "placeId": "ee5a623b-c714-4848-8589-229b35989d43",
                    "geoJsonBoundry": null,
                    "externalId": null,
                    "source": "GOOGLE",
                    "places": null,
                    "viewport": null,
                    "district": null,
                    "name": "Orient Paper,P.O. Amlai Paper Mills, Madhya Pradesh 484117",
                    "state": null,
                    "category": "Hub",
                    "subDistrict": null,
                    "controllingBranchId": null
                },
                "overSpeedSince": null,
                "imei": null,
                "assosiatedShipmentsId": [
                    "a3776e63-b8ff-4f63-afe1-e97fe56d0a45"
                ],
                "status": "AT"
            },
            "place": null,
            "controllingBranchId": null,
            "gateOutTime": null,
            "status": "AT"
        },
        {
            "departureTime": null,
            "gateInTime": null,
            "actualActivityStartTime": null,
            "actualActivityEndTime": null,
            "preActWtTime": null,
            "uuid": "1f7bcfcf-68fa-4c1d-b22b-f14553fe1a03",
            "consignmentDelivered": null,
            "resourceDropOff": null,
            "resourcePickup": null,
            "eta": null,
            "stageName": "AHMEDNAGAR,UTTARAKHAND",
            "hub": null,
            "arrivalTime": null,
            "expectedActivityStartTime": null,
            "secondaryStatus": null,
            "consignmentPickUps": null,
            "postActWtTime": null,
            "tripPoint": {
                "outOfTrackSince": null,
                "creationTime": null,
                "purpose": "Delivery",
                "plannedArrival": null,
                "currentGpsState": null,
                "updates": null,
                "uuid": "1f7bcfcf-68fa-4c1d-b22b-f14553fe1a03",
                "sequenceId": null,
                "isDisconnected": false,
                "isOutOfTrack": false,
                "routeDeviationMinimumDistanceConstraint": null,
                "eta": null,
                "routeId": null,
                "expectedActivityStartTime": null,
                "actualDeparture": null,
                "vehicleId": null,
                "place": {
                    "hubId": null,
                    "boundary": null,
                    "address": ",Dehradun,248007,05,IN",
                    "accessibility": null,
                    "addedBy": "7d7304f0-5638-470b-be88-6fa6f9be24b4",
                    "center": {
                        "latitude": 30.35715222874985,
                        "longitude": 77.95075298133186
                    },
                    "suggestedRadius": 1000,
                    "isOwned": null,
                    "centerCoordinates": [
                        77.95075298133186,
                        30.35715222874985
                    ],
                    "placeId": "3736e4ad-ebf8-4b47-93aa-7e3f0b0bbb26",
                    "geoJsonBoundry": null,
                    "externalId": "657",
                    "source": "FRETRON",
                    "places": null,
                    "viewport": null,
                    "district": "AHMEDNAGAR",
                    "name": "AHMEDNAGAR,UTTARAKHAND",
                    "state": "UTTARAKHAND",
                    "category": "Unloading Point",
                    "subDistrict": "226018",
                    "controllingBranchId": null
                },
                "isOverSpeed": false,
                "remainingDistance": 0,
                "actualActivityStartTime": null,
                "forShipmentStages": [
                    "1f7bcfcf-68fa-4c1d-b22b-f14553fe1a03"
                ],
                "actualActivityEndTime": null,
                "actualArrival": null,
                "purposedDistance": null,
                "plannedDeparture": null,
                "currentLocation": null,
                "isAutoCompleted": false,
                "coveredDistance": null,
                "hub": null,
                "overSpeedSince": null,
                "imei": null,
                "assosiatedShipmentsId": [
                    "a3776e63-b8ff-4f63-afe1-e97fe56d0a45"
                ],
                "status": "NEXT"
            },
            "place": {
                "hubId": null,
                "boundary": null,
                "address": ",Dehradun,248007,05,IN",
                "accessibility": null,
                "addedBy": "7d7304f0-5638-470b-be88-6fa6f9be24b4",
                "center": {
                    "latitude": 30.35715222874985,
                    "longitude": 77.95075298133186
                },
                "suggestedRadius": 1000,
                "isOwned": null,
                "centerCoordinates": [
                    77.95075298133186,
                    30.35715222874985
                ],
                "placeId": "3736e4ad-ebf8-4b47-93aa-7e3f0b0bbb26",
                "geoJsonBoundry": null,
                "externalId": "657",
                "source": "FRETRON",
                "places": null,
                "viewport": null,
                "district": "AHMEDNAGAR",
                "name": "AHMEDNAGAR,UTTARAKHAND",
                "state": "UTTARAKHAND",
                "category": "Unloading Point",
                "subDistrict": "226018",
                "controllingBranchId": null
            },
            "controllingBranchId": null,
            "gateOutTime": null,
            "status": "NEXT"
        }
    ],
    "remarks": null,
    "syncUpExpiryTime": null,
    "shipmentStatus": "Planned"
}
const token = "Beaer eyJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3MzY5MjE0NjQsInVzZXJJZCI6IjNmNjdlNmFmLWU5MjAtNGNmNy1hMTViLWIzMjc4Zjc4ZjFkMiIsImVtYWlsIjoic2FoaWwuYWdnYXJ3YWxAZnJldHJvbi5jb20iLCJtb2JpbGVOdW1iZXIiOiI3MDU2MDMyNzQ0Iiwib3JnSWQiOiI3ZDczMDRmMC01NjM4LTQ3MGItYmU4OC02ZmE2ZjliZTI0YjQiLCJuYW1lIjoiU2FoaWwiLCJvcmdUeXBlIjoiRkxFRVRfT1dORVIiLCJpc0dvZCI6dHJ1ZSwicG9ydGFsVHlwZSI6ImJhc2ljIn0.-jbR-vqgFT7s8z8Fc1z-4z6fyuEBY22mv6kew-y6l50"
import rp from "request-promise"
const FRT_PUB_BASE_URL = "https://apis.fretron.com";
try {
    let deliveryStage = sh.shipmentStages.filter(stage => stage.tripPoint?.purpose === "Delivery")
    let orderReason = deliveryStage[0]?.tripPoint?.place?.externalId ?? deliveryStage[0]?.tripPoint?.hub?.externalId
    let cfObj = getCfObj("Order Reason Code", orderReason)
    let payloadAddCf = {
        shipmentId: sh?.uuid,
        updates: [
            {
                keyToUpdate: "customfields",
                updatedValue: [cfObj]
            }
        ]
    };
    await bulkSync(payloadAddCf);
    console.log(`Order Reason Cf added to shipment ${sh.uuid}`)
    // let res = await sendDataToSAP(sh.uuid)
    // console.log(`Response status: ${res?.status} and error: ${res?.error}`)
} catch (e) {
    console.log(`Caught Error - ${e.message}`)
}

function getCfObj(key, value, valueType = "string", fieldType = "text") {
    return {
        fieldKey: key,
        valueType: valueType,
        fieldType: fieldType,
        value: value
    };
}

async function bulkSync(payload) {
    let url = `${FRT_PUB_BASE_URL}/shipment/v1/shipment/bulk/sync`;
    try {
        let res = await rp({
            uri: url,
            method: "POST",
            body: payload,
            headers: {
                authorization: token,
            },
            json: true,
        });
        if (res.status === 200) {
            return res.data;
        } else {
            console.log(
                `Bulk Sync api res error for sh ${payload.shipmentId} : ${res.error}`
            );
        }
    } catch (e) {
        console.log(
            `Catched error in bulkSync api for sh ${payload.shipmentId} : ${e.message}`
        );
    }
    return null;
}

// API Maker - Custom Action: Send Vehicle Data To SAP
async function sendDataToSAP(shId) {
    const response = await rp({
        uri: `https://apis.fretron.com/automate/autoapi/run/de9b44a8-6068-4430-9bab-736b79775573`,
        method: "POST",
        json: true,
        body: {
            "shipmentId": shId
        }
    });
    return response
}